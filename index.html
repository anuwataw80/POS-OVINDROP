<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>POS Ovindrop Cyanotype</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root{ --radius:10px; --muted:#666; --accent:#1890ff; }
        body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:16px; background:#f6f7fb; color:#111; }
        header{ display:flex; align-items:center; justify-content: space-between; gap:12px; margin-bottom:12px; }
        header h1{ font-size:18px; margin:0; }
        main{ display:grid; grid-template-columns: 1fr 420px; gap:20px; }
        @media (max-width:980px){ main{ grid-template-columns: 1fr; } }

        /* product grid */
        #productCategories .category { background:#fff; padding:14px; border-radius:var(--radius); box-shadow:0 2px 8px rgba(0,0,0,.04); margin-bottom:12px; }
        #productCategories .category h2{ margin:0 0 10px 0; font-size:16px; border-bottom:1px solid #eee; padding-bottom:8px; }
        .grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(140px,1fr)); gap:12px; }
        .item{ background:#fff; border:1px solid #e6eef9; border-radius:10px; padding:12px; text-align:center; cursor:pointer; transition:all .12s; }
        .item:hover{ transform:translateY(-4px); box-shadow:0 6px 18px rgba(25,50,100,.06); border-color:var(--accent); }
        .item img{ width:56px; height:56px; object-fit:contain; margin-bottom:8px; }
        .item .label{ font-weight:600; margin-bottom:6px; }
        .item .price{ color:var(--muted); font-size:13px; }

        /* cart panel */
        .card{ background:#fff; padding:14px; border-radius:var(--radius); box-shadow:0 2px 8px rgba(0,0,0,.04); }
        .cart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cart-header h2 { margin: 0; }

        .channel-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .channel-button { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; background: #f0f0f0; cursor: pointer; }
        .channel-button.active { background: #1890ff; color: #fff; border-color: #1890ff; }
        
        table{ width:100%; border-collapse:collapse; table-layout: fixed; }
        th,td{ padding:8px 10px; border-bottom:1px solid #f0f0f0; text-align:center; vertical-align:middle; }
        th:first-child, td:first-child { text-align: left; }
        
        thead th{ background:#fafbfd; text-transform:uppercase; font-size:12px; color:var(--muted); }
        td.center{ text-align:center; }
        
        .btn-small{ padding:6px 8px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer; }
        .btn-plus{ background:#e6f7ff; border-color:var(--accent); color:var(--accent); }
        .btn-minus{ background:#fff0f0; border-color:#f5c2c2; color:#b40000; }
        .btn-remove{ background:#ffebe6; border-color:#ff7b74; color:#b40000; padding:6px 8px; border-radius:6px; }
        
        /* แก้ไขปัญหาคอลัมน์ขยับ */
        #cartTable thead th:nth-child(1) { width: 45%; }
        #cartTable thead th:nth-child(2) { width: 15%; }
        #cartTable thead th:nth-child(3) { width: 25%; }
        #cartTable thead th:nth-child(4) { width: 15%; }
        #cartTable td:first-child { font-size: 0.85rem; }
        
        .qty-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            width: 100%;
        }
        .qty-display {
            padding: 0 4px;
            width: 15px;
            text-align: center;
        }
        .action-row {
          text-align: right;
        }
        
        /* แก้ไขส่วนนี้: ลบ border-bottom ทั้งหมดออกจากแถวควบคุม */
        .action-row td {
          border-bottom: none !important;
          padding-top: 0;
        }
        
        /* และลบ border-bottom ออกจาก td ที่เป็นรายการสินค้าด้วย */
        #cartTable tr:not(.action-row) td {
          border-bottom: none;
        }

        .cart-footer{ display:flex; flex-direction: column; gap:12px; margin-top:12px; }
        .total-summary{ display: flex; flex-direction: column; gap: 8px; font-weight: 700; align-self: flex-end; }
        .total-summary div { display: flex; justify-content: space-between; gap: 20px; }
        .total-summary .final-total { font-size: 1em; border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px; }
        .total-summary .subtotal-display, .total-summary .final-total-display { font-size: 1em; }
        .confirm-wrap{ display:flex; justify-content:flex-end; width:100%; }
        .confirm{ background:#0a7b33; color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; }
        .confirm:active{ transform:translateY(1px); }
        
        .muted{ color:var(--muted); font-size:13px; }
        .small{ font-size:13px; color:var(--muted); }
        
        .header-buttons {
            display: flex;
            gap: 8px;
        }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 10px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }

        /* History Modal */
        .history-item { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .history-item h3 { margin: 0; font-size: 16px; }
        .history-item ul { list-style: none; padding: 0; margin: 0; }
        .history-footer { display: flex; justify-content: flex-end; margin-top: 10px; }
        .history-footer button { margin-left: 10px; }
        
        /* Clear Confirmation Modal */
        #clearConfirmModal .modal-content {
          text-align: center;
        }
        #clearConfirmModal .modal-buttons {
          display: flex;
          justify-content: center;
          gap: 10px;
          margin-top: 20px;
        }
        .btn-save-data {
          background-color: #1890ff;
          color: white;
          border: none;
          padding: 10px 15px;
          border-radius: 5px;
          cursor: pointer;
        }
        .btn-confirm-clear {
          background-color: #b40000;
          color: white;
          border: none;
          padding: 10px 15px;
          border-radius: 5px;
          cursor: pointer;
        }

        /* Edit Products Modal */
        #editProductsModal .modal-content {
            max-height: 90vh; /* Limits the height of the modal */
            display: flex;
            flex-direction: column;
        }
        #editProductsScroll {
            overflow-y: auto; /* Adds a scrollbar for vertical overflow */
            padding-right: 15px; /* Adds spacing for the scrollbar */
        }
        .edit-category-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .edit-category-section h3 { margin-top: 0; display: flex; align-items: center; }
        .edit-category-section h3 input { border: none; font-size: 16px; font-weight: bold; }
        .edit-category-header { display: flex; justify-content: space-between; align-items: center; }
        .edit-category-header .category-name-group { display: flex; align-items: center; gap: 8px; }
        .edit-category-header .category-name-group input { font-size: 16px; font-weight: bold; }
        .edit-category-header .btn-delete-cat { font-size: 18px; border: none; background: transparent; color: #b40000; cursor: pointer; }
        .product-list { margin-top: 10px; padding-left: 20px; border-left: 2px solid #f0f0f0; }
        .product-list-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .product-list-item input { flex-grow: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; }
        .btn-delete-item { background: #ffebe6; color: #b40000; border: 1px solid #ff7b74; }
        .btn-add-item { margin-top: 10px; background: #e6f7ff; color: #1890ff; border: 1px solid #1890ff; }
        .btn-save-edit { background: #0a7b33; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin-top: 20px; }
        .product-input-group { display: flex; gap: 8px; flex-grow: 1; }
        .product-input-group input { flex-grow: 1; }
        .product-icon-upload { display: flex; align-items: center; gap: 10px; flex-grow: 1; }
        .product-icon-upload input[type="file"] { flex-grow: 1; }
        .product-icon-upload img { width: 30px; height: 30px; object-fit: contain; }
        
        /* Summary Modal */
        #summaryModal .modal-content {
          width: 90%;
          max-width: 800px;
        }
        .summary-controls {
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
          margin-bottom: 20px;
          align-items: center;
        }
        .summary-controls label {
          font-weight: bold;
        }
        .summary-controls input[type="date"] {
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 5px;
        }
        .summary-controls button {
          padding: 8px 12px;
          border-radius: 5px;
        }
    </style>
</head>
<body>
    <header>
        <h1>POS — Ovindrop Cyanotype</h1>
        <div class="header-buttons">
            <button id="editProductsBtn" class="btn-small">แก้ไขรายการสินค้า</button>
            <button id="summaryBtn" class="btn-small">สรุปยอด</button>
        </div>
    </header>

    <main>
        <section id="productCategories">
        </section>

        <aside class="card">
            <div class="cart-header">
                <h2>ตะกร้า</h2>
                <button id="editChannelsBtn" class="btn-small">แก้ไขช่องทางการสั่งซื้อ</button>
            </div>
            <div id="channelButtons" class="channel-buttons">
            </div>

            <table id="cartTable" aria-label="Cart table">
                <thead>
                    <tr>
                        <th>สินค้า</th>
                        <th class="center">ราคา</th>
                        <th class="center">จำนวน</th>
                        <th class="center">รวม</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div class="cart-footer">
                <div class="total-summary">
                    <div>ราคารวมสินค้า: <span class="subtotal-display" id="subtotalDisplay">0</span> ฿</div>
                    <div id="feeRow" style="display: none;">ค่าธรรมเนียม: <span id="feeDisplay">0</span> ฿</div>
                    <div class="final-total">ยอดที่ได้รับ: <span class="final-total-display" id="finalTotalDisplay">0</span> ฿</div>
                </div>
                <div class="confirm-wrap">
                    <button id="confirmBtn" class="confirm">✅ ยืนยันการสั่งซื้อ</button>
                </div>
            </div>
        </aside>
    </main>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close history-close">&times;</span>
            <h2>ประวัติการซื้อ</h2>
            <div id="historyList"></div>
            <div class="history-footer">
                <button id="clearHistoryBtn" class="btn-small" style="display: none;">ล้างประวัติการซื้อ</button>
            </div>
        </div>
    </div>
    
    <div id="clearConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close clear-close">&times;</span>
            <h2 style="color:#b40000;">⚠️ คำเตือน</h2>
            <p>การล้างประวัติการสั่งซื้อจะทำให้ข้อมูลใน Google Sheet หายไปอย่างถาวร</p>
            <p><b>กรุณากด "บันทึกข้อมูล" ก่อนล้างทุกครั้ง</b></p>
            <div class="modal-buttons">
                <button id="saveAndClearBtn" class="btn-save-data">บันทึกข้อมูล</button>
                <button id="confirmClearBtn" class="btn-confirm-clear">บันทึกแล้ว</button>
            </div>
        </div>
    </div>
    
    <div id="editProductsModal" class="modal">
        <div class="modal-content">
            <span class="close edit-close">&times;</span>
            <h2>แก้ไขรายการสินค้า</h2>
            <div id="editProductsScroll">
              <div id="editCategoriesContainer"></div>
              <button id="addCategoryBtn" class="btn-small btn-add-item">+ เพิ่มหมวดหมู่ใหม่</button>
            </div>
            <div style="display:flex; justify-content:flex-end; margin-top:20px;">
              <button id="saveEditBtn" class="btn-save-edit">บันทึกการแก้ไข</button>
            </div>
        </div>
    </div>

    <div id="editChannelsModal" class="modal">
        <div class="modal-content">
            <span class="close channels-close">&times;</span>
            <h2>แก้ไขช่องทางการสั่งซื้อ</h2>
            <div id="editChannelsContainer">
                <div style="display: flex; gap: 8px; font-weight: bold; margin-bottom: 10px;">
                    <div style="flex: 2;">ช่องทางการสั่งซื้อ</div>
                    <div style="flex: 1;">ค่าธรรมเนียม (%)</div>
                    <div style="width: 30px;"></div>
                </div>
            </div>
            <button id="addChannelBtn" class="btn-small btn-add-item">+ เพิ่มช่องทางใหม่</button>
            <div style="display:flex; justify-content:flex-end; margin-top:20px;">
                <button id="saveChannelsBtn" class="btn-save-edit">บันทึกการแก้ไข</button>
            </div>
        </div>
    </div>

    <div id="summaryModal" class="modal">
        <div class="modal-content">
            <span class="close summary-close">&times;</span>
            <h2>สร้างรายงานสรุปยอด</h2>
            <div class="summary-controls">
                <label for="startDate">จากวันที่:</label>
                <input type="date" id="startDate">
                <label for="endDate">ถึงวันที่:</label>
                <input type="date" id="endDate">
                <button id="generateSummaryBtn" class="btn-small btn-save-edit">สร้างรายงานสรุป</button>
            </div>
            <p class="muted">เมื่อกด "สร้างรายงานสรุป" ระบบจะสร้างข้อมูลในชีต "Dashboard" โดยอัตโนมัติ</p>
        </div>
    </div>

    <script>
        // ** เปลี่ยน appsScriptUrl เป็น URL ของคุณเอง **
        const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbwOGMAsED0sUx3FRrkpcK5OPMdMTF9JNeyqB6_XwC53kJGquGMicURUJ50VqJ25EIZQaQ/exec';

        let products = {};
        let channels = {};
        let activeChannel = "หน้าร้าน";
        let cart = {};

        document.addEventListener('DOMContentLoaded', async () => {
          await fetchDataFromGoogleSheet();
          renderProducts();
          renderChannels();
          renderCart();
        });
        
        async function fetchDataFromGoogleSheet() {
            try {
                const response = await fetch(appsScriptUrl + '?action=fetchData');
                const data = await response.json();
                if (data.products) {
                    products = data.products;
                }
                if (data.channels) {
                    channels = data.channels;
                    activeChannel = Object.keys(channels)[0];
                }
                console.log("Data fetched from Google Sheet:", { products, channels });
                renderProducts();
                renderChannels();
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('ไม่สามารถดึงข้อมูลจาก Google Sheet ได้ กรุณาตรวจสอบ URL และสคริปต์');
            }
        }

        function makeId(cat, sub){
            return encodeURIComponent(cat + '||' + sub);
        }
        
        function renderProducts(){
            const productCategories = document.getElementById('productCategories');
            productCategories.innerHTML = '';
            for(const cat in products){
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                categoryDiv.innerHTML = `
                    <h2>${cat}</h2>
                    <div class="grid" data-cat="${cat}"></div>
                `;
                productCategories.appendChild(categoryDiv);

                const grid = categoryDiv.querySelector('.grid');
                for(const sub in products[cat]){
                    const p = products[cat][sub];
                    const id = makeId(cat, sub);
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.setAttribute('role','button');
                    div.dataset.id = id;
                    div.dataset.name = `${cat} ${sub}`;
                    div.dataset.price = p.price;
                    div.innerHTML = `
                        <img src="${p.icon}" alt="${sub}">
                        <div class="label">${sub}</div>
                        <div class="price">${p.price} ฿</div>
                    `;
                    div.addEventListener('click', () => addToCart(id, div.dataset.name, Number(div.dataset.price), p.profit));
                    grid.appendChild(div);
                }
            }
        }

        function addToCart(id, name, price, profit = 0){
            if(!cart[id]){
                cart[id] = { id, name, price: Number(price), qty: 0, profit: (profit==null?0:profit) };
            }
            cart[id].qty += 1;
            renderCart();
        }

        function changeQty(id, delta){
            if(!cart[id]) return;
            cart[id].qty += delta;
            if(cart[id].qty <= 0) delete cart[id];
            renderCart();
        }

        function removeItem(id){
            if(cart[id]) delete cart[id];
            renderCart();
        }

        function renderChannels() {
            const channelButtons = document.getElementById('channelButtons');
            channelButtons.innerHTML = '';
            for (const channelName in channels) {
                const button = document.createElement('button');
                button.className = 'channel-button';
                button.textContent = channelName;
                button.dataset.channel = channelName;
                if (channelName === activeChannel) {
                    button.classList.add('active');
                }
                button.onclick = () => {
                    activeChannel = channelName;
                    document.querySelectorAll('.channel-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderCart();
                };
                channelButtons.appendChild(button);
            }
        }

        function renderCart() {
            const tbody = document.querySelector("#cartTable tbody");
            tbody.innerHTML = "";
            let subtotal = 0;
            for (const id in cart) {
                const item = cart[id];
                const itemSubtotal = item.price * item.qty;
                subtotal += itemSubtotal;
                
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.price}</td>
                    <td>${item.qty}</td>
                    <td>${itemSubtotal.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);

                const actionTr = document.createElement("tr");
                actionTr.className = 'action-row';
                actionTr.innerHTML = `
                    <td></td>
                    <td></td>
                    <td>
                        <div class="qty-controls">
                            <button class="btn-small btn-plus" data-id="${id}">+</button>
                            <button class="btn-small btn-minus" data-id="${id}">-</button>
                        </div>
                    </td>
                    <td><button class="btn-small btn-remove" data-id="${id}">ลบ</button></td>
                `;
                tbody.appendChild(actionTr);
            }
            
            let fee = 0;
            let finalTotal = subtotal;
            
            const feeRate = channels[activeChannel] || 0;
            if (feeRate > 0) {
                fee = subtotal * feeRate;
                finalTotal = subtotal - fee;
                document.getElementById('feeRow').style.display = 'flex';
                document.getElementById('feeRow').innerHTML = `ค่าธรรมเนียม (${activeChannel} ${feeRate*100}%): <span id="feeDisplay">${fee.toFixed(2)}</span> ฿`;
            } else {
                document.getElementById('feeRow').style.display = 'none';
            }
            
            document.getElementById('subtotalDisplay').innerText = subtotal.toFixed(2);
            document.getElementById('finalTotalDisplay').innerText = finalTotal.toFixed(2);
        
            tbody.querySelectorAll('.btn-plus').forEach(btn => {
                btn.addEventListener('click', () => changeQty(btn.dataset.id, 1));
            });
            tbody.querySelectorAll('.btn-minus').forEach(btn => {
                btn.addEventListener('click', () => changeQty(btn.dataset.id, -1));
            });
            tbody.querySelectorAll('.btn-remove').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (confirm('ยืนยันการลบรายการนี้?')) {
                        removeItem(btn.dataset.id);
                    }
                });
            });
        }
        
        async function confirmPurchase() {
            if (Object.keys(cart).length === 0) {
                alert('กรุณาเพิ่มสินค้าในตะกร้าก่อน');
                return;
            }
            
            if (!confirm(`ยืนยันการขายผ่านช่องทาง "${activeChannel}" ยอดรวม ${document.getElementById('finalTotalDisplay').innerText} ฿?`)) {
                return;
            }

            const payload = {
                action: 'recordSale',
                channel: activeChannel,
                items: Object.values(cart).map(item => ({
                    name: item.name,
                    price: item.price,
                    qty: item.qty,
                    profit: item.profit
                }))
            };

            try {
                const response = await fetch(appsScriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    alert('บันทึกการขายเรียบร้อยแล้ว!');
                    cart = {}; // Clear cart
                    renderCart();
                } else {
                    alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + result.message);
                }
            } catch (error) {
                console.error('Error confirming purchase:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์');
            }
        }
        
        async function saveEditedProducts() {
            const newProducts = {};
            const categories = document.querySelectorAll('#editProductsContainer > .edit-category-section');
            categories.forEach(catDiv => {
                const newCatName = catDiv.querySelector('input[type="text"]').value;
                newProducts[newCatName] = {};
                catDiv.querySelectorAll('.product-list-item').forEach(itemDiv => {
                    const sub = itemDiv.querySelector('input[data-field="sub"]').value;
                    const price = parseFloat(itemDiv.querySelector('input[data-field="price"]').value);
                    const profit = parseFloat(itemDiv.querySelector('input[data-field="profit"]').value);
                    const icon = itemDiv.querySelector('img').src;
                    newProducts[newCatName][sub] = { price: price, icon: icon, profit: profit };
                });
            });
            
            try {
                const response = await fetch(appsScriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'updateProducts', products: newProducts })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('บันทึกการแก้ไขสินค้าเรียบร้อยแล้ว');
                    await fetchDataFromGoogleSheet(); // Reload data
                    document.getElementById('editProductsModal').style.display = 'none';
                } else {
                    alert('เกิดข้อผิดพลาดในการบันทึกการแก้ไข: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving products:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
            }
        }

        async function saveEditedChannels() {
            const newChannels = {};
            const channelInputs = document.querySelectorAll('#editChannelsContainer .channel-input-group');
            channelInputs.forEach(group => {
                const name = group.querySelector('input[data-field="name"]').value;
                const fee = parseFloat(group.querySelector('input[data-field="fee"]').value) / 100;
                newChannels[name] = fee;
            });
            
            try {
                const response = await fetch(appsScriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'updateChannels', channels: newChannels })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('บันทึกการแก้ไขช่องทางเรียบร้อยแล้ว');
                    await fetchDataFromGoogleSheet(); // Reload data
                    document.getElementById('editChannelsModal').style.display = 'none';
                } else {
                    alert('เกิดข้อผิดพลาดในการบันทึกการแก้ไข: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving channels:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
            }
        }

        async function generateSummary() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('กรุณาเลือกช่วงเวลาให้ครบถ้วน');
                return;
            }

            try {
                const response = await fetch(appsScriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'generateSummary', startDate, endDate })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('สร้างรายงานสรุปยอดเรียบร้อยแล้ว สามารถดูได้ที่ Google Sheet ในชีต "Dashboard"');
                    document.getElementById('summaryModal').style.display = 'none';
                } else {
                    alert('เกิดข้อผิดพลาดในการสร้างรายงาน: ' + result.message);
                }
            } catch (error) {
                console.error('Error generating summary:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
            }
        }

        // --- Modal Logic ---
        document.getElementById('confirmBtn').onclick = confirmPurchase;
        document.getElementById('summaryBtn').onclick = () => document.getElementById('summaryModal').style.display = 'block';
        document.getElementById('editProductsBtn').onclick = () => { renderEditableProducts(); document.getElementById('editProductsModal').style.display = 'block'; };
        document.getElementById('editChannelsBtn').onclick = () => { renderEditableChannels(); document.getElementById('editChannelsModal').style.display = 'block'; };
        document.getElementById('saveEditBtn').onclick = saveEditedProducts;
        document.getElementById('saveChannelsBtn').onclick = saveEditedChannels;
        document.getElementById('generateSummaryBtn').onclick = generateSummary;
        
        document.querySelectorAll('.close').forEach(btn => {
            btn.onclick = () => {
                btn.closest('.modal').style.display = 'none';
            };
        });
        
        window.onclick = (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        // Edit Products Modal
        function renderEditableProducts() {
            const container = document.getElementById('editCategoriesContainer');
            container.innerHTML = '';
            
            const categoryNames = Object.keys(products);
            categoryNames.forEach(cat => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'edit-category-section';
                categoryDiv.innerHTML = `
                    <div class="edit-category-header">
                        <div class="category-name-group">
                            <input type="text" value="${cat}" data-oldname="${cat}">
                            <button class="btn-delete-cat" data-cat="${cat}">&times;</button>
                        </div>
                    </div>
                    <div class="product-list"></div>
                    <button class="btn-small btn-add-item" data-cat="${cat}">+ เพิ่มสินค้าใหม่</button>
                `;
                container.appendChild(categoryDiv);

                const productListDiv = categoryDiv.querySelector('.product-list');
                for (const sub in products[cat]) {
                    const p = products[cat][sub];
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'product-list-item';
                    itemDiv.innerHTML = `
                        <div class="product-icon-upload">
                            <img src="${p.icon}" alt="${sub}">
                            <input type="file" accept="image/*" data-oldicon="${p.icon}">
                        </div>
                        <div class="product-input-group">
                            <input type="text" placeholder="ชื่อสินค้า" value="${sub}" data-field="sub" data-oldname="${sub}">
                            <input type="number" placeholder="ราคา" value="${p.price}" data-field="price">
                            <input type="number" placeholder="กำไร" value="${p.profit}" data-field="profit">
                        </div>
                        <button class="btn-small btn-delete-item" data-cat="${cat}" data-sub="${sub}">&times;</button>
                    `;
                    productListDiv.appendChild(itemDiv);
                    
                    const fileInput = itemDiv.querySelector('input[type="file"]');
                    fileInput.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                const img = itemDiv.querySelector('img');
                                img.src = event.target.result;
                            };
                            reader.readAsDataURL(file);
                        }
                    };
                }
            });
            
            document.getElementById('addCategoryBtn').onclick = () => {
                const newCatName = prompt("กรุณาใส่ชื่อหมวดหมู่ใหม่:");
                if (newCatName && !products[newCatName]) {
                    products[newCatName] = {};
                    renderEditableProducts();
                } else if (newCatName) {
                    alert("ชื่อหมวดหมู่นี้มีอยู่แล้ว");
                }
            };

            container.querySelectorAll('.btn-add-item').forEach(btn => {
                btn.onclick = () => {
                    const cat = btn.dataset.cat;
                    const newName = prompt("กรุณาใส่ชื่อสินค้าใหม่ (เช่น 100mL):");
                    if (!newName || products[cat][newName]) {
                        if (newName) alert("ชื่อสินค้านี้มีอยู่แล้ว หรือชื่อไม่ถูกต้อง");
                        return;
                    }
                    products[cat][newName] = { price: 0, icon: "", profit: 0 };
                    renderEditableProducts();
                };
            });
            
            container.querySelectorAll('.btn-delete-item').forEach(btn => {
                btn.onclick = () => {
                    const cat = btn.dataset.cat;
                    const sub = btn.dataset.sub;
                    if (confirm(`ยืนยันการลบสินค้า "${sub}"?`)) {
                        delete products[cat][sub];
                        renderEditableProducts();
                    }
                };
            });
            
            container.querySelectorAll('.btn-delete-cat').forEach(btn => {
                btn.onclick = () => {
                    const cat = btn.dataset.cat;
                    if (confirm(`ยืนยันการลบหมวดหมู่ "${cat}" และสินค้าทั้งหมดในหมวด?`)) {
                        delete products[cat];
                        renderEditableProducts();
                    }
                };
            });
        }

        // Edit Channels Modal
        function renderEditableChannels() {
            const container = document.getElementById('editChannelsContainer');
            const existingGroups = container.querySelectorAll('.channel-input-group');
            existingGroups.forEach(group => group.remove());
            
            for (const name in channels) {
                const feePercent = channels[name] * 100;
                const group = document.createElement('div');
                group.className = 'channel-input-group';
                group.style = "display: flex; gap: 8px; margin-bottom: 8px; align-items: center;";
                group.innerHTML = `
                    <input type="text" value="${name}" data-field="name" style="flex: 2;">
                    <input type="number" value="${feePercent}" data-field="fee" style="flex: 1;">
                    <button class="btn-small btn-delete-channel" data-name="${name}">&times;</button>
                `;
                container.appendChild(group);
            }

            document.getElementById('addChannelBtn').onclick = () => {
                const newChannel = prompt("กรุณาใส่ชื่อช่องทางใหม่ (เช่น Facebook, Shopee):");
                if (newChannel && !channels[newChannel]) {
                    channels[newChannel] = 0;
                    renderEditableChannels();
                } else if (newChannel) {
                    alert("ชื่อช่องทางนี้มีอยู่แล้ว");
                }
            };
            
            container.querySelectorAll('.btn-delete-channel').forEach(btn => {
                btn.onclick = () => {
                    const name = btn.dataset.name;
                    if (confirm(`ยืนยันการลบช่องทาง "${name}"?`)) {
                        delete channels[name];
                        renderEditableChannels();
                    }
                };
            });
        }
    </script>
</body>
</html>
