<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ovindrop Cyanotype</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{ --radius:10px;
--muted:#666; --accent:#1890ff; --success:#0a7b33; }
    body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:16px; background:#f6f6f3; color:#111;
}
    header{ display:flex; align-items:center; justify-content: space-between; gap:12px; margin-bottom:12px; }
    header h1{ font-size:18px; margin:0;
}
    main{ display:grid; grid-template-columns: 1fr 420px; gap:20px; }
    @media (max-width:980px){ main{ grid-template-columns: 1fr;
} }

    /* product grid */
    #productCategories .category { background:#fff; padding:14px; border-radius:var(--radius);
box-shadow:0 2px 8px rgba(0,0,0,.04); margin-bottom:12px; }
    #productCategories .category h2{ margin:0 0 10px 0; font-size:16px; border-bottom:1px solid #eee;
padding-bottom:8px; }
    .grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(140px,1fr)); gap:12px; }
    .item{ background:#fff; border:1px solid #e6eef9; border-radius:10px;
padding:12px; text-align:center; cursor:pointer; transition:all .12s; }
    .item:hover{ transform:translateY(-4px); box-shadow:0 6px 18px rgba(25,50,100,.06); border-color:var(--accent);
}
    .item img{ width:56px; height:56px; object-fit:contain; margin-bottom:8px; }
    .item .label{ font-weight:600; margin-bottom:6px;
}
    .item .price{ color:var(--muted); font-size:13px; }

    /* cart panel */
    .card{ background:#ebf6ff;
padding:14px; border-radius:var(--radius); box-shadow:0 2px 8px rgba(0,0,0,.04); }
    .cart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
}
    .cart-header h2 { margin: 0; }

    .channel-buttons { display: flex; gap: 8px;
margin-bottom: 10px; }
    .channel-button { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; background: #f0f0f0;
cursor: pointer; }
    .channel-button.active { background: #1890ff; color: #fff; border-color: #1890ff;
}
    
    table{ width:100%; border-collapse:collapse; table-layout: fixed; }
    th,td{ padding:8px 10px;
border-bottom:1px solid #f0f0f0; text-align:center; vertical-align:middle; }
    th:first-child, td:first-child { text-align: left;
}
    
    thead th{ background:#fafbfd; text-transform:uppercase; font-size:12px; color:var(--muted); }
    td.center{ text-align:center;
}
    
    .btn-small{ padding:6px 8px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer;
}
    .btn-plus{ background:#e6f7ff; border-color:var(--accent); color:var(--accent); }
    .btn-minus{ background:#fff0f0; border-color:#f5c2c2; color:#b40000;
}
    .btn-remove{ background:#ffebe6; border-color:#ff7b74; color:#b40000; padding:6px 8px; border-radius:6px;
}
    .btn-primary{ background:#1890ff; color:#fff; border:1px solid #1890ff; }
    .btn-danger{ background:#b40000; color:#fff; border:1px solid #b40000; }
    .btn-save-edit{ background:linear-gradient(180deg,#22c55e,#16a34a); color:#fff; border:none; padding:10px 16px; border-radius:10px; font-weight:700; box-shadow:0 6px 20px rgba(22,163,74,.25); }
    .btn-save-edit:hover{ filter:brightness(1.02); }
    .btn-save-edit:active{ transform:translateY(1px); }
    
    /* แก้ไขปัญหาคอลัมน์ขยับ */
    #cartTable thead th:nth-child(1) { width: 45%;
}
    #cartTable thead th:nth-child(2) { width: 15%; }
    #cartTable thead th:nth-child(3) { width: 25%;
}
    #cartTable thead th:nth-child(4) { width: 15%; }
    #cartTable td:first-child { font-size: 0.85rem;
}
    
    .qty-controls {
        display: flex;
justify-content: flex-end;
        align-items: center;
        gap: 12px;
        width: 100%;
    }
    .qty-display {
        padding: 0 4px;
width: 15px;
        text-align: center;
    }
    .action-row {
      text-align: right;
}
    
    .action-row td {
      border-bottom: none !important;
padding-top: 0;
    }
    
    #cartTable tr:not(.action-row) td {
      border-bottom: none;
}

    .cart-footer{ display:flex; flex-direction: column; gap:12px; margin-top:12px; }
    .total-summary{ display: flex; flex-direction: column;
gap: 8px; font-weight: 700; align-self: flex-end; }
    .total-summary div { display: flex; justify-content: space-between; gap: 20px;
}
    .total-summary .final-total { font-size: 1em; border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px;
}
    .total-summary .subtotal-display, .total-summary .final-total-display { font-size: 1em; }
    .confirm-wrap{ display:flex; justify-content:flex-end; width:100%;
}
    .confirm{ background:#0a7b33; color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; transition:filter .15s ease; }
    .confirm:hover{ filter:brightness(1.03); }
    .confirm.confirm-ordered{ background:#9aa0a6; color:#fff; cursor:default; }
    .confirm:active{ transform:translateY(1px);
}
    
    .muted{ color:var(--muted); font-size:13px; }
    .small{ font-size:13px; color:var(--muted);
}
    
    .header-buttons {
        display: flex;
gap: 8px;
    }

    /* Modals */
    .modal { display: none; position: fixed; z-index: 1;
left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
    .modal-content { background-color: #fefefe;
margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 10px;
}
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold;
}
    .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer;
}

    .history-item { border-bottom: 1px solid #eee; padding-bottom: 10px;
margin-bottom: 10px; }
    .history-item h3 { margin: 0; font-size: 16px;
}
    .history-item ul { list-style: none; padding: 0; margin: 0;
}
    .history-footer { display: flex; justify-content: flex-end; align-items:center; gap:10px; margin-top: 10px;
}
    .history-footer button { margin-left: 0; }

    /* Edit Order Modal (locked layout) */
    .edit-item-row{ display:grid; grid-template-columns: 1fr auto; align-items:center; column-gap:10px; }
    .edit-item-name{ min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .edit-item-right{ display:grid; grid-template-columns: 90px 96px auto; align-items:center; column-gap:10px; }
    .edit-item-qty input{ width:100%; padding:6px 8px; border:1px solid #ddd; border-radius:6px; }
    .edit-item-subtotal{ width:96px; text-align:right; white-space:nowrap; font-variant-numeric: tabular-nums; }
    .edit-order-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
    .pill { padding:4px 8px; background:#f5f5f5; border-radius:999px; font-size:12px; color:#444; }

    /* Summarize modal polish */
    #summarizeModal .modal-content { max-width: 520px; }
    #summarizeModal .date-input { padding:8px 10px; border:1px solid #ddd; border-radius:6px; }
    #fetchAndExportBtn { padding:12px 18px; font-weight:700; border-radius:8px; font-size:15px; }

    /* Edit Products Modal - base */
    #editProductsModal .modal-content { max-height: 90vh; display:flex; flex-direction:column; }
    #editProductsScroll { overflow-y:auto; padding-right: 10px; }
    .edit-list-head { display:grid; grid-template-columns: 110px minmax(165px, 1fr) 90px 90px 60px; column-gap:22px; margin:6px 0 8px 0; font-weight:700; color:var(--muted); align-items:center; }
    .edit-category-section .product-list { margin-top:6px; }
    .product-list-item { display:grid; grid-template-columns: 110px minmax(165px, 1fr) 90px 90px 60px; column-gap:22px; align-items:center; padding:6px 0; border-bottom:1px solid #f4f6f8; }
    .product-icon-upload { display:flex; align-items:center; gap:12px; margin-right:18px; }
    .product-icon-upload img { width:40px; height:40px; object-fit:contain; border:1px solid #eee; border-radius:8px; background:#fff; }
    .product-icon-upload input[type="file"] { width:120px; max-width:120px; }
    .edit-category-section .product-input-group { display: contents; }
    .product-list-item [data-field="sub"] { max-width:100%; padding:6px 8px; }
    .product-list-item [data-field="price"], .product-list-item [data-field="profit"] { width:64px; padding:6px 8px; }
    .edit-category-header { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .edit-category-header .category-name-group { display:flex; align-items:center; gap:8px; }
    .edit-category-header .category-name-group input { font-size:16px; font-weight:bold; padding:6px 8px; border:1px solid #ddd; border-radius:6px; }

    /* Edit Channels Modal - compact inputs with spacing */
    .chan-head { display:grid; grid-template-columns: minmax(180px, 320px) 120px 60px; column-gap:16px; font-weight:700; color:var(--muted); margin:6px 0 8px 0; align-items:center; }
    #editChannelsContainer .product-list-item { display:grid; grid-template-columns: minmax(180px, 320px) 120px 60px; column-gap:16px; align-items:center; padding:6px 0; border-bottom:1px solid #f4f6f8; }
    #editChannelsContainer .product-input-group { display: contents; }
    #editChannelsContainer input[data-field="name"]{ max-width:260px; width:100%; padding:6px 8px; border:1px solid #ddd; border-radius:6px; }
    #editChannelsContainer input[data-field="fee"]{ max-width:110px; width:100%; padding:6px 8px; border:1px solid #ddd; border-radius:6px; }

    /* Toast */
    .toast-container{ position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; z-index:9999; }
    .toast{ background:#10b981; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 10px 24px rgba(16,185,129,.3); font-weight:700; opacity:0; transform:translateY(8px); animation:toast-in .2s ease-out forwards; }
    @keyframes toast-in{ to{ opacity:1; transform:translateY(0);} }
    .toast-hide{ animation:toast-out .25s ease-in forwards; }
    @keyframes toast-out{ to{ opacity:0; transform:translateY(8px);} }

    /* ===== Overrides requested ===== */
    /* 1) ลดความยาวช่องสินค้า ~ครึ่งหนึ่ง และให้พื้นที่ "ไม่ได้เลือกไฟล์" */
    .edit-list-head,
    .product-list-item{
      grid-template-columns: 200px minmax(80px, 0.5fr) 72px 72px 60px;
      column-gap: 24px;
    }
    .product-icon-upload{ gap:14px; }
    .product-icon-upload input[type="file"]{
      width: 180px;
      max-width: 220px;
    }
    /* 2) ปุ่ม “ดึงข้อมูลและ Export” ให้เด่น */
    #fetchAndExportBtn{
      background: linear-gradient(180deg,#22c55e,#16a34a);
      color:#fff;
      padding:12px 20px;
      border:none;
      border-radius:10px;
      font-weight:700;
      font-size:15px;
      box-shadow:0 8px 20px rgba(22,163,74,.25);
      transition: filter .15s ease, transform .05s ease;
    }
    #fetchAndExportBtn:hover{ filter:brightness(1.03); }
    #fetchAndExportBtn:active{ transform: translateY(1px); }

    /* 3) เว้นช่องว่างระหว่างปุ่ม “+ เพิ่มสินค้าใหม่” กับหมวดถัดไป */
    #editProductsModal .edit-category-section > .btn-add-item{
      margin-top: 10px;
      margin-bottom: 20px;
    }
    #editProductsModal .edit-category-section + .edit-category-section{
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <header>
    <h1 id="posTitle">Ovindrop Cyanotype</h1>
    <div class="header-buttons">
      <button id="editTitleBtn" class="btn-small">แก้ไขชื่อ POS</button>
      <button id="editProductsBtn" class="btn-small">แก้ไขรายการสินค้า</button>
      <button id="historyBtn" class="btn-small">ประวัติการซื้อ</button>
      <button id="summarizeBtn" class="btn-small">สรุปยอด</button>
    </div>
  </header>

  <main>
    <section id="productCategories">
      </section>

    <aside class="card">
      <div class="cart-header">
        <h2>ตะกร้า</h2>
        <button id="editChannelsBtn" class="btn-small">แก้ไขช่องทางการสั่งซื้อ</button>
      </div>
     
<div id="channelButtons" class="channel-buttons">
        </div>

      <table id="cartTable" aria-label="Cart table">
        <thead>
          <tr>
            <th>สินค้า</th>
            <th class="center">ราคา</th>
            <th class="center">จำนวน</th>
            <th class="center">รวม</th>
          </tr>
 
</thead>
        <tbody></tbody>
      </table>

      <div class="cart-footer">
        <div class="total-summary">
            <div>ราคารวมสินค้า: <span class="subtotal-display" id="subtotalDisplay">0</span> ฿</div>
            <div id="feeRow" style="display: none;">ค่าธรรมเนียม: <span id="feeDisplay">0</span> ฿</div>
            <div class="final-total">ยอดที่ได้รับ: <span class="final-total-display" id="finalTotalDisplay">0</span> ฿</div>
        </div>
    
<div class="confirm-wrap">
          <button id="confirmBtn" class="confirm">✅ ยืนยันการสั่งซื้อ</button>
        </div>
      </div>
    </aside>
  </main>

  <div id="historyModal" class="modal">
    <div class="modal-content">
      <span class="close history-close">&times;</span>
      <h2>ประวัติการซื้อ (จาก Local)</h2>
      <div id="historyList"></div>
      <div class="history-footer">
        <button id="clearHistoryBtn" class="btn-small">ล้างประวัติการซื้อ</button>
      </div>
    </div>
  </div>
  
 
<div id="clearConfirmModal" class="modal">
    <div class="modal-content">
      <span class="close clear-close">&times;</span>
      <h2 style="color:#b40000;">⚠️ คำเตือน</h2>
      <p>การล้างประวัติการสั่งซื้อจะทำให้ข้อมูลสูญหายอย่างถาวร</p>
      <p><b>กรุณาบันทึกข้อมูลก่อนล้างทุกครั้ง</b></p>
      <div class="modal-buttons">
        <button id="saveAndClearBtn" class="btn-save-data">บันทึกข้อมูล</button>
        <button id="confirmClearBtn" class="btn-confirm-clear">บันทึกแล้ว</button>
      </div>
    </div>
  </div>
  
  <div id="editProductsModal" class="modal">
    <div class="modal-content">
      <span class="close edit-close">&times;</span>
    
<h2>แก้ไขรายการสินค้า</h2>
      <div id="editProductsScroll">
        <div id="editCategoriesContainer"></div>
        <button id="addCategoryBtn" class="btn-small btn-add-item">+ เพิ่มหมวดหมู่ใหม่</button>
      </div>
      <div style="display:flex;
justify-content:flex-end; margin-top:20px;">
        <button id="saveEditBtn" class="btn-save-edit">บันทึกการแก้ไข</button>
      </div>
    </div>
  </div>

  <div id="editChannelsModal" class="modal">
    <div class="modal-content">
        <span class="close channels-close">&times;</span>
        <h2>แก้ไขช่องทางการสั่งซื้อ</h2>
        <div id="editChannelsContainer"></div>
        <button id="addChannelBtn" class="btn-small btn-add-item">+ เพิ่มช่องทางใหม่</button>
        
<div style="display:flex; justify-content:flex-end; margin-top:20px;">
            <button id="saveChannelsBtn" class="btn-save-edit">บันทึกการแก้ไข</button>
        </div>
    </div>
  </div>

<div id="summarizeModal" class="modal">
    <div class="modal-content">
        <span class="close summarize-close">&times;</span>
        <h2>สรุปยอดจาก Google Sheet</h2>
        <p>เลือกช่วงเวลาที่ต้องการสรุปยอด:</p>
        <div style="display: flex; justify-content: space-around; align-items: center; gap: 10px; margin-bottom: 20px;">
            <span style="font-weight: bold; font-size: 1.1em;">จาก</span>
            <input type="date" id="startDate" class="date-input">
            <span style="font-weight: bold; font-size: 1.1em;">ถึง</span>
            <input type="date" id="endDate" class="date-input">
        </div>
        <div style="display: flex; justify-content: flex-end;">
            <button id="fetchAndExportBtn" class="btn-save-data">ดึงข้อมูลและ Export</button>
        </div>
    </div>
</div>

<div id="historyFromSheetModal" class="modal">
    <div class="modal-content">
        <span class="close history-sheet-close">&times;</span>
        <h2>ประวัติการสั่งซื้อล่าสุด</h2>
        <div id="historyLoader">กำลังดึงข้อมูล...</div>
        <div id="historyFromSheetContent" style="display: none;"></div>
        <div class="history-footer">
            <button id="historySheetClearBtn" class="btn-small btn-danger">ล้างประวัติการซื้อ</button>
            <span class="small muted">การลบทั้งชุดทำใน Google Sheet</span>
        </div>
    </div>
</div>

<!-- Edit Order Modal -->
<div id="editOrderModal" class="modal">
  <div class="modal-content">
    <span class="close edit-order-close">&times;</span>
    <h2>แก้ไขรายการออเดอร์</h2>
    <div id="editOrderMeta" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0;">
      <span class="pill">เลขที่: <span id="editOrderId"></span></span>
      <span class="pill">วันที่: <span id="editOrderDatetime"></span></span>
      <label>ช่องทาง:
        <select id="editOrderChannel" class="btn-small" style="padding:6px 8px;">
        </select>
      </label>
    </div>
    <div style="font-weight:700; color:var(--muted); margin:8px 0 6px 0;">รายการสินค้า</div>
    <div id="editOrderRows"></div>
    <div style="margin-top:8px;">
      <button id="editOrderAddItem" class="btn-small btn-primary">+ เพิ่มสินค้า</button>
    </div>
    <div class="total-summary" style="margin-top:16px; max-width:420px; margin-left:auto;">
      <div>ราคารวมสินค้า: <span id="editSubtotal">0</span> ฿</div>
      <div>ค่าธรรมเนียม: <span id="editFee">0</span> ฿</div>
      <div class="final-total">ยอดที่ได้รับ: <span id="editFinalTotal">0</span> ฿</div>
    </div>
    <div class="edit-order-actions">
      <button id="editOrderDeleteBtn" class="btn-small btn-danger">ลบออเดอร์</button>
      <button id="editOrderSaveBtn" class="btn-small btn-primary">บันทึก</button>
    </div>
  </div>
</div>

  <div id="toastRoot" class="toast-container" style="display:none;"></div>

  <script>
    // ====== เพิ่มฟังก์ชันแก้ไขชื่อ POS ======
    document.addEventListener('DOMContentLoaded', function() {
      const savedTitle = localStorage.getItem('posTitle');
      if (savedTitle) document.getElementById('posTitle').textContent = savedTitle;
      document.getElementById('editTitleBtn').onclick = function() {
        const h1 = document.getElementById('posTitle');
        const newTitle = prompt('กรุณาใส่ชื่อ POS ใหม่:', h1.textContent);
        if (newTitle && newTitle.trim() !== '') {
          h1.textContent = newTitle.trim();
          localStorage.setItem('posTitle', newTitle.trim());
        }
      };
    });
    // ====== END ======

    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyuc3UDjWl4IWS6y2r5QZjc2NRqKAsJee_TTJe97IXFwWvPeVHfwNAsM7cOkZKJG6l5rw/exec";
    const SPREADSHEET_ID = "1o2H4Vc6SNf31OIM8ZurpS5CC-gp9m60GcrNdBdKCs20";
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit`;

    const defaultProducts = {"แยกส่วน":{"50mL":{"price":149,"icon":"https://img.icons8.com/color/96/test-tube.png","profit":97},"100mL":{"price":269,"icon":"https://img.icons8.com/color/96/test-tube.png","profit":193},"210mL":{"price":529,"icon":"https://img.icons8.com/color/96/test-tube.png","profit":341}},"ผสมพร้อมใช้":{"100mL":{"price":149,"icon":"https://img.icons8.com/color/96/beaker.png","profit":97},"100mL+อุปกรณ์":{"price":169,"icon":"https://img.icons8.com/color/96/beaker.png","profit":null},"200mL":{"price":269,"icon":"https://img.icons8.com/color/96/beaker.png","profit":null},"200mL+อุปกรณ์":{"price":289,"icon":"https://img.icons8.com/color/96/beaker.png","profit":null},"500mL":{"price":549,"icon":"https://img.icons8.com/color/96/beaker.png","profit":null},"500mL+อุปกรณ์":{"price":569,"icon":"https://img.icons8.com/color/96/beaker.png","profit":null}},"Box set":{"100mL":{"price":229,"icon":"https://img.icons8.com/color/96/box.png","profit":null},"200mL":{"price":349,"icon":"https://img.icons8.com/color/96/box.png","profit":null}},"แบบผง":{"Total 500mL":{"price":849,"icon":"https://img.icons8.com/color/96/powder.png","profit":null},"Total 1L":{"price":1690,"icon":"https://img.icons8.com/color/96/powder.png","profit":null}}};
    const defaultChannels = { "หน้าร้าน": 0, "Shopee": 0.13 };

    let products = JSON.parse(localStorage.getItem('products')) || defaultProducts;
    let channels = JSON.parse(localStorage.getItem('channels')) || defaultChannels;
    let activeChannel = 'หน้าร้าน';
    let cart = {};

let confirmButtonRef = null;
let confirmResetTimer = null;

function setConfirmOrdered() {
  if (!confirmButtonRef) return;
  if (confirmResetTimer) { clearTimeout(confirmResetTimer); confirmResetTimer = null; }
  confirmButtonRef.textContent = 'สั่งซื้อแล้ว';
  confirmButtonRef.classList.add('confirm-ordered');
  confirmButtonRef.disabled = true;
  confirmResetTimer = setTimeout(resetConfirmButton, 3000);
}
function resetConfirmButton() {
  if (!confirmButtonRef) return;
  if (confirmResetTimer) { clearTimeout(confirmResetTimer); confirmResetTimer = null; }
  confirmButtonRef.textContent = '✅ ยืนยันการสั่งซื้อ';
  confirmButtonRef.classList.remove('confirm-ordered');
  confirmButtonRef.disabled = false;
}

function makeId(cat, sub){ return encodeURIComponent(cat + '||' + sub); }
function saveProductsToLocalStorage() { localStorage.setItem('products', JSON.stringify(products)); }
function saveChannelsToLocalStorage() { localStorage.setItem('channels', JSON.stringify(channels)); }

function renderProducts(){
  const productCategories = document.getElementById('productCategories');
  productCategories.innerHTML = '';
  for(const cat in products){
    const categoryDiv = document.createElement('div');
    categoryDiv.className = 'category';
    categoryDiv.innerHTML = `
      <h2>${cat}</h2>
      <div class="grid" data-cat="${cat}"></div>
    `;
    productCategories.appendChild(categoryDiv);
    const grid = categoryDiv.querySelector('.grid');
    for(const sub in products[cat]){
      const p = products[cat][sub];
      const id = makeId(cat, sub);
      const div = document.createElement('div');
      div.className = 'item';
      div.setAttribute('role','button');
      div.dataset.id = id;
      div.dataset.name = `${cat} ${sub}`;
      div.dataset.price = p.price;
      div.innerHTML = `
        <img src="${p.icon}" alt="${sub}">
        <div class="label">${sub}</div>
        <div class="price">${p.price} ฿</div>
      `;
      div.addEventListener('click', () => addToCart(id, div.dataset.name, Number(div.dataset.price), p.profit));
      grid.appendChild(div);
    }
  }
}

function addToCart(id, name, price, profit = 0){
  if(!cart[id]){ cart[id] = { id, name, price: Number(price), qty: 0, profit: (profit==null?0:profit) }; }
  cart[id].qty += 1;
  resetConfirmButton();
  renderCart();
}
function changeQty(id, delta){ if(!cart[id]) return; cart[id].qty += delta; if(cart[id].qty <= 0) delete cart[id]; renderCart(); }
function removeItem(id){ if(cart[id]) delete cart[id]; renderCart(); }

function renderChannels() {
  const channelButtons = document.getElementById('channelButtons');
  channelButtons.innerHTML = '';
  for (const channelName in channels) {
    const button = document.createElement('button');
    button.className = 'channel-button';
    button.textContent = channelName;
    button.dataset.channel = channelName;
    if (channelName === activeChannel) button.classList.add('active');
    button.onclick = () => {
      activeChannel = channelName;
      document.querySelectorAll('.channel-button').forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      renderCart();
    };
    channelButtons.appendChild(button);
  }
}

function renderCart() {
  const tbody = document.querySelector("#cartTable tbody");
  tbody.innerHTML = "";
  let subtotal = 0;
  for (const id in cart) {
    const item = cart[id];
    const itemSubtotal = item.price * item.qty; subtotal += itemSubtotal;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.name}</td>
      <td>${item.price}</td>
      <td>${item.qty}</td>
      <td>${itemSubtotal.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
    const actionTr = document.createElement("tr");
    actionTr.className = 'action-row';
    actionTr.innerHTML = `
      <td></td>
      <td></td>
      <td>
        <div class="qty-controls">
            <button class="btn-small btn-plus" data-id="${id}">+</button>
            <button class="btn-small btn-minus" data-id="${id}">-</button>
        </div>
      </td>
      <td><button class="btn-small btn-remove" data-id="${id}">ลบ</button></td>
    `;
    tbody.appendChild(actionTr);
  }
  let fee = 0; let finalTotal = subtotal;
  const feeRate = channels[activeChannel] || 0;
  if (feeRate > 0) {
    fee = subtotal * feeRate; finalTotal = subtotal - fee;
    document.getElementById('feeRow').style.display = 'flex';
    document.getElementById('feeRow').innerHTML = `ค่าธรรมเนียม (${activeChannel} ${feeRate*100}%): <span id="feeDisplay">${fee.toFixed(2)}</span> ฿`;
  } else {
    document.getElementById('feeRow').style.display = 'none';
  }
  document.getElementById('subtotalDisplay').innerText = subtotal.toFixed(2);
  document.getElementById('finalTotalDisplay').innerText = finalTotal.toFixed(2);
  tbody.querySelectorAll('.btn-plus').forEach(btn => btn.addEventListener('click', () => changeQty(btn.dataset.id, 1)));
  tbody.querySelectorAll('.btn-minus').forEach(btn => btn.addEventListener('click', () => changeQty(btn.dataset.id, -1)));
  tbody.querySelectorAll('.btn-remove').forEach(btn => btn.addEventListener('click', () => { if (confirm('ยืนยันการลบรายการนี้?')) removeItem(btn.dataset.id); }));
}

// =========== แก้ไข event delegation สำหรับเพิ่ม/ลบสินค้า/หมวด ===========
function renderEditableProducts() {
  const container = document.getElementById('editCategoriesContainer');
  container.innerHTML = '';
  const categoryNames = Object.keys(products);

  categoryNames.forEach(cat => {
    const categoryDiv = document.createElement('div');
    categoryDiv.className = 'edit-category-section';
    categoryDiv.innerHTML = `
      <div class="edit-category-header">
        <div class="category-name-group">
          <input type="text" value="${cat}" data-oldname="${cat}">
          <button class="btn-small btn-delete-cat" data-cat="${cat}">ลบหมวด</button>
        </div>
      </div>
      <div class="edit-list-head">
        <div>รูป</div>
        <div>สินค้า</div>
        <div>ราคา (฿)</div>
        <div>กำไร (฿)</div>
        <div></div>
      </div>
      <div class="product-list"></div>
      <button class="btn-small btn-add-item" data-cat="${cat}">+ เพิ่มสินค้าใหม่</button>
    `;
    container.appendChild(categoryDiv);

    const productListDiv = categoryDiv.querySelector('.product-list');
    for (const sub in products[cat]) {
      const p = products[cat][sub];
      const itemDiv = document.createElement('div');
      itemDiv.className = 'product-list-item';
      itemDiv.innerHTML = `
        <div class="product-icon-upload">
          <img src="${p.icon}" alt="${sub}">
          <input type="file" accept="image/*" data-oldicon="${p.icon}">
        </div>
        <div class="product-input-group">
          <input type="text" placeholder="ชื่อสินค้า" value="${sub}" data-field="sub" data-oldname="${sub}">
          <input type="number" placeholder="ราคา" value="${p.price}" data-field="price">
          <input type="number" placeholder="กำไร" value="${p.profit}" data-field="profit">
        </div>
        <button class="btn-small btn-delete-item" data-cat="${cat}" data-sub="${sub}">ลบ</button>
      `;
      productListDiv.appendChild(itemDiv);

      const fileInput = itemDiv.querySelector('input[type="file"]');
      fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = itemDiv.querySelector('img'); img.src = event.target.result;
            fileInput.dataset.newicon = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      };
    }
  });

  // ใช้ event delegation
  document.getElementById('editProductsScroll').onclick = function(e) {
    // เพิ่มหมวดหมู่ใหม่
    if (e.target && e.target.id === 'addCategoryBtn') {
      const newCatName = prompt("กรุณาใส่ชื่อหมวดหมู่ใหม่:");
      if (newCatName && !products[newCatName]) {
        products[newCatName] = {};
        renderEditableProducts();
      } else if (newCatName) {
        alert("ชื่อหมวดหมู่นี้มีอยู่แล้ว");
      }
    }
    // เพิ่มสินค้าใหม่
    if (e.target && e.target.classList.contains('btn-add-item') && e.target.dataset.cat) {
      const cat = e.target.dataset.cat;
      const newName = prompt("กรุณาใส่ชื่อสินค้าใหม่ (เช่น 100mL):");
      if (!newName || products[cat][newName]) {
        if (newName) alert("ชื่อสินค้านี้มีอยู่แล้ว หรือชื่อไม่ถูกต้อง");
        return;
      }
      products[cat][newName] = { price: 0, icon: "", profit: 0 };
      renderEditableProducts();
    }
    // ลบสินค้า
    if (e.target && e.target.classList.contains('btn-delete-item')) {
      const cat = e.target.dataset.cat; const sub = e.target.dataset.sub;
      if (cat && sub && confirm(`คุณต้องการลบ "${sub}" จาก "${cat}"?`)) {
        delete products[cat][sub];
        renderEditableProducts();
      }
    }
    // ลบหมวดหมู่
    if (e.target && e.target.classList.contains('btn-delete-cat')) {
      const cat = e.target.dataset.cat;
      if (cat && confirm(`คุณต้องการลบหมวดหมู่ "${cat}" และสินค้าทั้งหมดในนั้น?`)) {
        delete products[cat];
        renderEditableProducts();
      }
    }
  };
}
// =========== END event delegation ===========

function saveEditedProducts() {
  const container = document.getElementById('editCategoriesContainer');
  const updatedProducts = {}; let hasError = false;

  container.querySelectorAll('.edit-category-section').forEach(section => {
    const oldCatName = section.querySelector('.category-name-group input').dataset.oldname;
    const newCatName = section.querySelector('.category-name-group input').value;
    if (!newCatName) { alert('ชื่อหมวดหมู่ต้องไม่ว่าง'); hasError = true; return; }
    if (updatedProducts[newCatName] && newCatName !== oldCatName) { alert(`ชื่อหมวดหมู่ "${newCatName}" มีอยู่แล้ว`); hasError = true; return; }
    updatedProducts[newCatName] = {};

    section.querySelectorAll('.product-list-item').forEach(item => {
      const oldName = item.querySelector('[data-field="sub"]').dataset.oldname;
      const newName = item.querySelector('[data-field="sub"]').value;
      const icon = item.querySelector('[data-oldicon]').dataset.newicon || item.querySelector('[data-oldicon]').dataset.oldicon;
      const price = Number(item.querySelector('[data-field="price"]').value);
      const profit = Number(item.querySelector('[data-field="profit"]').value);

      if (!newName || isNaN(price) || isNaN(profit)) { alert('กรุณาใส่ข้อมูลให้ครบถ้วนและถูกต้อง'); hasError = true; return; }
      if (updatedProducts[newCatName][newName] && newName !== oldName) { alert(`ชื่อสินค้า "${newName}" มีอยู่แล้วในหมวดหมู่ "${newCatName}"`); hasError = true; return; }

      updatedProducts[newCatName][newName] = { price, icon, profit };
    });
  });
  if (hasError) return;

  products = updatedProducts;
  saveProductsToLocalStorage();
  renderProducts();
  document.getElementById('editProductsModal').style.display = 'none';
  showToast('บันทึกสินค้าแล้ว');
}

// =========== event delegation สำหรับช่องทางการสั่งซื้อ ===========
function renderEditableChannels() {
  const container = document.getElementById('editChannelsContainer');
  const channelHeader = `
    <div class="chan-head">
      <div>ช่องทางการสั่งซื้อ</div>
      <div>ค่าธรรมเนียม (%)</div>
      <div></div>
    </div>
  `;
  container.innerHTML = channelHeader;

  for (const name in channels) {
    const div = document.createElement('div');
    div.className = 'product-list-item';
    div.innerHTML = `
      <div class="product-input-group">
        <input type="text" placeholder="ชื่อช่องทาง" value="${name}" data-field="name" data-oldname="${name}">
        <input type="number" placeholder="ค่าธรรมเนียม (%)" value="${channels[name] * 100}" data-field="fee">
      </div>
      <button class="btn-small btn-delete-item" data-name="${name}">ลบ</button>
    `;
    container.appendChild(div);
  }

  // ใช้ event delegation
  document.getElementById('editChannelsModal').onclick = function(e) {
    // เพิ่มช่องทางใหม่
    if (e.target && e.target.id === 'addChannelBtn') {
      const newName = prompt('กรุณาใส่ชื่อช่องทางใหม่:');
      const newFee = prompt('กรุณาใส่ค่าธรรมเนียม (%) เช่น 13:');
      if (newName && !isNaN(newFee)) { channels[newName] = Number(newFee) / 100; renderEditableChannels(); }
      else { alert('ข้อมูลไม่ถูกต้อง'); }
    }
    // ลบช่องทาง
    if (e.target && e.target.classList.contains('btn-delete-item')) {
      const name = e.target.dataset.name;
      if (name && confirm(`คุณต้องการลบช่องทาง "${name}"?`)) {
        delete channels[name];
        renderEditableChannels();
      }
    }
  };
}
// =========== END event delegation ===========

function saveEditedChannels() {
  const container = document.getElementById('editChannelsContainer');
  const updatedChannels = {}; let hasError = false;

  container.querySelectorAll('.product-list-item').forEach(item => {
    const oldName = item.querySelector('[data-field="name"]').dataset.oldname;
    const newName = item.querySelector('[data-field="name"]').value;
    const fee = Number(item.querySelector('[data-field="fee"]').value);

    if (!newName || isNaN(fee)) { alert('กรุณาใส่ข้อมูลช่องทางให้ครบถ้วนและถูกต้อง'); hasError = true; return; }
    if (updatedChannels[newName] && newName !== oldName) { alert(`ชื่อช่องทาง "${newName}" มีอยู่แล้ว`); hasError = true; return; }

    updatedChannels[newName] = fee / 100;
  });
  if (hasError) return;

  channels = updatedChannels;
  saveChannelsToLocalStorage();
  document.getElementById('editChannelsModal').style.display = 'none';

  if (!channels[activeChannel]) { activeChannel = Object.keys(channels)[0]; }
  renderChannels();
  renderCart();
  showToast('บันทึกช่องทางแล้ว');
}
// ---- (ส่วนอื่นๆ ใน script ไม่เปลี่ยน) ----

    document.addEventListener('DOMContentLoaded', () => {
      renderProducts(); renderChannels(); renderCart();

      const historyModal = document.getElementById('historyModal');
      const editProductsModal = document.getElementById('editProductsModal');
      const editChannelsModal = document.getElementById('editChannelsModal');
      const summarizeModal = document.getElementById('summarizeModal');
      const historyFromSheetModal = document.getElementById('historyFromSheetModal');
      const editOrderModal = document.getElementById('editOrderModal');

      const historyBtn = document.getElementById('historyBtn');
      const summarizeBtn = document.getElementById('summarizeBtn');
      const editProductsBtn = document.getElementById('editProductsBtn');
      const editChannelsBtn = document.getElementById('editChannelsBtn');

      const editCloseBtn = document.querySelector('.edit-close');
      const channelsCloseBtn = document.querySelector('.channels-close');
      const summarizeCloseBtn = document.querySelector('.summarize-close');
      const historySheetCloseBtn = document.querySelector('.history-sheet-close');
      const editOrderCloseBtn = document.querySelector('.edit-order-close');

      const saveEditBtn = document.getElementById('saveEditBtn');
      const saveChannelsBtn = document.getElementById('saveChannelsBtn');
      const addChannelBtn = document.getElementById('addChannelBtn');
      const fetchAndExportBtn = document.getElementById('fetchAndExportBtn');
      confirmButtonRef = document.getElementById('confirmBtn');

      historyBtn.onclick = () => { renderHistoryFromGoogleSheet(); };
      editProductsBtn.onclick = () => { renderEditableProducts(); editProductsModal.style.display = "block"; };
      editChannelsBtn.onclick = () => { renderEditableChannels(); editChannelsModal.style.display = 'block'; };
      editCloseBtn.onclick = () => { editProductsModal.style.display = "none"; };
      channelsCloseBtn.onclick = () => { editChannelsModal.style.display = 'none'; };
      summarizeBtn.onclick = () => { summarizeModal.style.display = 'block'; };
      summarizeCloseBtn.onclick = () => { summarizeModal.style.display = 'none'; };
      historySheetCloseBtn.onclick = () => { historyFromSheetModal.style.display = 'none'; };
      editOrderCloseBtn.onclick = () => { editOrderModal.style.display = 'none'; };

      const historySheetClearBtn = document.getElementById('historySheetClearBtn');
      if (historySheetClearBtn) { historySheetClearBtn.disabled = false; historySheetClearBtn.onclick = () => { window.open(SHEET_URL, '_blank'); }; }

      window.onclick = (event) => {
        if (event.target === historyModal) historyModal.style.display = "none";
        if (event.target === editProductsModal) editProductsModal.style.display = "none";
        if (event.target === editChannelsModal) editChannelsModal.style.display = 'none';
        if (event.target === summarizeModal) summarizeModal.style.display = 'none';
        if (event.target === historyFromSheetModal) historyFromSheetModal.style.display = 'none';
        if (event.target === editOrderModal) editOrderModal.style.display = 'none';
      };

      saveEditBtn.onclick = () => { saveEditedProducts(); };
      saveChannelsBtn.onclick = () => { saveEditedChannels(); };
      fetchAndExportBtn.onclick = handleFetchAndExport;

      document.getElementById('confirmBtn').onclick = async () => {
        if(Object.keys(cart).length === 0){ alert('ตะกร้าว่าง โปรดเพิ่มสินค้าก่อนยืนยัน'); return; }

        setConfirmOrdered();

        let subtotal = 0; for (const id in cart) { const item = cart[id]; subtotal += item.price * item.qty; }
        const feeRate = channels[activeChannel] || 0;
        let fee = subtotal * feeRate; let finalTotal = subtotal - fee;

        const orderId = 'INV' + new Date().toISOString().slice(0,19).replace(/[:T]/g,'');
        const dt = new Date().toISOString();

        const orderData = {
          orderId, datetime: dt, channel: activeChannel,
          subtotal: subtotal.toFixed(2), fee: fee.toFixed(2), finalTotal: finalTotal.toFixed(2),
          items: []
        };
        for(const id in cart){
          const it = cart[id]; const itemSubtotal = it.price * it.qty;
          orderData.items.push({ name: it.name, price: it.price, qty: it.qty, subtotal: itemSubtotal });
        }
        cart = {}; renderCart();
        
        const ok = await saveOrderToGoogleSheet(orderData);
        if (ok) showToast('สั่งซื้อสำเร็จ');
      };
    });
  </script>
</body>
</html>
