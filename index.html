<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POS Ovindrop Cyanotype</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --radius: 10px;
      --muted: #666;
      --accent: #1890ff;
    }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      margin: 16px;
      background: #f6f7fb;
      color: #111;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }

    main {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 20px;
    }
    @media (max-width: 980px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    /* product grid */
    #productCategories .category {
      background: #fff;
      padding: 14px;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      margin-bottom: 12px;
    }
    #productCategories .category h2 {
      margin: 0 0 10px 0;
      font-size: 18px;
    }
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
    }
    .product-item {
      background: #f7f7f7;
      border-radius: var(--radius);
      text-align: center;
      padding: 12px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .product-item:hover {
      transform: scale(1.03);
    }
    .product-item h3 {
      font-size: 14px;
      margin: 0;
      word-wrap: break-word;
    }
    .product-item p {
      font-size: 12px;
      color: var(--muted);
      margin: 4px 0 0 0;
    }

    /* cart */
    #cart {
      position: sticky;
      top: 16px;
      background: #fff;
      padding: 16px;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      display: flex;
      flex-direction: column;
      height: fit-content;
    }
    #cart h2 {
      margin: 0 0 10px 0;
      font-size: 18px;
    }
    #cart-items {
      flex-grow: 1;
      overflow-y: auto;
      max-height: 400px;
      margin-bottom: 16px;
    }
    #cart-items .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px dashed #eee;
    }
    #cart-items .cart-item:last-child {
      border-bottom: none;
    }
    .cart-item-info {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    .cart-item-info span {
      font-size: 14px;
      font-weight: bold;
    }
    .cart-item-info small {
      font-size: 12px;
      color: var(--muted);
    }
    .cart-item-actions {
      display: flex;
      gap: 5px;
      align-items: center;
    }
    .cart-item-actions button {
      background: #eee;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
    }
    .cart-item-actions .remove-btn {
      color: #e53935;
    }
    .cart-item-actions .qty {
      min-width: 20px;
      text-align: center;
    }

    /* Summary */
    #summary {
      display: flex;
      flex-direction: column;
      gap: 8px;
      border-top: 1px solid #ddd;
      padding-top: 12px;
      margin-top: auto;
    }
    #summary .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #summary .summary-row span:last-child {
      font-weight: bold;
    }
    #summary .summary-row.total-row {
      font-size: 18px;
    }
    #channel-select {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    /* buttons */
    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    .btn-confirm {
      background: var(--accent);
      color: #fff;
      margin-top: 10px;
    }
    .btn-confirm:hover {
      background: #007bff;
    }
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
      margin-top: 10px;
    }
    .btn-secondary:hover {
      background: #e0e0e0;
    }

    /* modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 600px;
      position: relative;
    }
    .close-btn {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      right: 20px;
      cursor: pointer;
    }
    .close-btn:hover,
    .close-btn:focus {
      color: black;
      text-decoration: none;
    }
    .history-detail {
      background: #f7f7f7;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: var(--radius);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .history-detail h4 {
      margin-top: 0;
      font-size: 16px;
    }
    .history-detail-items {
      margin-top: 10px;
    }
    .history-detail-items ul {
      list-style-type: none;
      padding-left: 0;
      margin: 0;
    }
    .history-detail-items li {
      font-size: 14px;
      color: #555;
    }
    .summary-form-group {
      margin-bottom: 15px;
    }
    .summary-form-group label {
      display: block;
      margin-bottom: 5px;
    }
    .summary-form-group input {
      width: calc(100% - 20px);
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    #historyFromSheetContent,
    #summaryFromSheetContent {
      max-height: 70vh;
      overflow-y: auto;
    }
    .loader {
      display: none;
      justify-content: center;
      align-items: center;
      height: 100px;
    }
  </style>
</head>

<body>
  <header>
    <h1>POS Ovindrop Cyanotype</h1>
    <button class="btn btn-secondary" onclick="openHistoryModal()">
      ประวัติการขาย
    </button>
  </header>
  <main>
    <div id="productCategories"></div>
    <div id="cart">
      <h2>ตะกร้า</h2>
      <div id="cart-items"></div>
      <select id="channel-select"></select>
      <div id="summary">
        <div class="summary-row">
          <span>รวม (ก่อนหักค่าธรรมเนียม):</span>
          <span id="subtotal">0.00 ฿</span>
        </div>
        <div class="summary-row">
          <span>ค่าธรรมเนียม:</span>
          <span id="fee">0.00 ฿</span>
        </div>
        <div class="summary-row total-row">
          <span>ยอดที่ได้รับ:</span>
          <span id="final-total">0.00 ฿</span>
        </div>
      </div>
      <button class="btn btn-confirm" id="confirmBtn">ยืนยันการขาย</button>
      <button class="btn btn-secondary" onclick="openSummaryModal()">
        สรุปยอดขาย
      </button>
    </div>
  </main>

  <div id="historyFromSheetModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('historyFromSheetModal')">
        &times;
      </span>
      <h2>ประวัติการขาย</h2>
      <div id="historyLoader" class="loader">กำลังโหลด...</div>
      <div id="historyFromSheetContent"></div>
    </div>
  </div>

  <div id="summaryFromSheetModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('summaryFromSheetModal')">
        &times;
      </span>
      <h2>สรุปยอดขาย</h2>
      <div id="summaryForm">
        <div class="summary-form-group">
          <label for="startDate">วันที่เริ่มต้น:</label>
          <input type="date" id="startDate" />
        </div>
        <div class="summary-form-group">
          <label for="endDate">วันที่สิ้นสุด:</label>
          <input type="date" id="endDate" />
        </div>
        <button class="btn" id="fetchAndExportBtn">
          แสดงและ Export ข้อมูล
        </button>
      </div>
      <div id="summaryFromSheetContent"></div>
    </div>
  </div>

  <script>
    const GOOGLE_APPS_SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbybJcY17TEwiZ_OOyXBBBBrWSLgTY5EoHgmV8Le9_m2LnGYiB4A79MZOxuulCdg_zov7g/exec";

    const products = {
      "สีน้ำ Cyanotype Ovindrop": [
        { id: "p1", name: "สีน้ำ A", price: 150 },
        { id: "p2", name: "สีน้ำ B", price: 150 },
        { id: "p3", name: "สีน้ำ C", price: 150 },
      ],
      "ชุดทดลอง": [
        { id: "p4", name: "ชุดทดลอง A", price: 350 },
        { id: "p5", name: "ชุดทดลอง B", price: 350 },
      ],
      "กระดาษ A4": [
        { id: "p6", name: "กระดาษ A4", price: 50 },
        { id: "p7", name: "กระดาษ A3", price: 100 },
      ],
    };

    const channels = {
      Shopee: 0.1,
      Lazada: 0.1,
      Tiktok: 0.1,
      Other: 0,
    };

    let cart = {};
    let activeChannel = "Other";

    function renderProducts() {
      const container = document.getElementById("productCategories");
      for (const category in products) {
        const categoryDiv = document.createElement("div");
        categoryDiv.className = "category";
        categoryDiv.innerHTML = `<h2>${category}</h2><div class="product-grid"></div>`;
        const grid = categoryDiv.querySelector(".product-grid");
        products[category].forEach((product) => {
          const productItem = document.createElement("div");
          productItem.className = "product-item";
          productItem.innerHTML = `<h3>${product.name}</h3><p>${product.price} ฿</p>`;
          productItem.onclick = () => addToCart(product);
          grid.appendChild(productItem);
        });
        container.appendChild(categoryDiv);
      }
    }

    function renderChannels() {
      const select = document.getElementById("channel-select");
      for (const channel in channels) {
        const option = document.createElement("option");
        option.value = channel;
        option.textContent = channel;
        select.appendChild(option);
      }
      select.value = activeChannel;
      select.onchange = (e) => {
        activeChannel = e.target.value;
        updateSummary();
      };
    }

    function addToCart(product) {
      if (cart[product.id]) {
        cart[product.id].qty++;
      } else {
        cart[product.id] = { ...product, qty: 1 };
      }
      renderCart();
    }

    function updateQuantity(id, change) {
      if (!cart[id]) return;
      cart[id].qty += change;
      if (cart[id].qty <= 0) {
        delete cart[id];
      }
      renderCart();
    }

    function renderCart() {
      const cartItemsContainer = document.getElementById("cart-items");
      cartItemsContainer.innerHTML = "";
      let subtotal = 0;
      for (const id in cart) {
        const item = cart[id];
        const itemSubtotal = item.price * item.qty;
        subtotal += itemSubtotal;
        const itemDiv = document.createElement("div");
        itemDiv.className = "cart-item";
        itemDiv.innerHTML = `
          <div class="cart-item-info">
            <span>${item.name}</span>
            <small>${item.price} ฿</small>
          </div>
          <div class="cart-item-actions">
            <button onclick="updateQuantity('${id}', -1)">-</button>
            <span class="qty">${item.qty}</span>
            <button onclick="updateQuantity('${id}', 1)">+</button>
          </div>
        `;
        cartItemsContainer.appendChild(itemDiv);
      }
      updateSummary();
    }

    function updateSummary() {
      let subtotal = 0;
      for (const id in cart) {
        subtotal += cart[id].price * cart[id].qty;
      }
      const feeRate = channels[activeChannel];
      const fee = subtotal * feeRate;
      const finalTotal = subtotal - fee;

      document.getElementById("subtotal").textContent =
        subtotal.toFixed(2) + " ฿";
      document.getElementById("fee").textContent = fee.toFixed(2) + " ฿";
      document.getElementById("final-total").textContent =
        finalTotal.toFixed(2) + " ฿";
    }

    async function saveOrderToGoogleSheet(orderData) {
      try {
        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "saveOrder",
            orderData: orderData,
          }),
          headers: {
            "Content-Type": "text/plain;charset=utf-8",
          },
        });
        const result = await response.json();
        if (result.status === "success") {
          alert("บันทึกออเดอร์เรียบร้อย!");
          cart = {};
          renderCart();
        } else {
          alert("เกิดข้อผิดพลาดในการบันทึกออเดอร์: " + result.message);
        }
      } catch (error) {
        console.error("Error saving order:", error);
        alert("เกิดข้อผิดพลาดในการเชื่อมต่อ: " + error.message);
      }
    }

    async function getSalesDataFromGoogleSheet(startDate, endDate) {
      try {
        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "getSalesData",
            startDate: startDate,
            endDate: endDate,
          }),
          headers: {
            "Content-Type": "text/plain;charset=utf-8",
          },
        });
        const result = await response.json();
        if (result.status === "success") {
          return result.data;
        } else {
          console.error(
            "Error fetching sales data from Google Sheet:",
            result.message
          );
          return [];
        }
      } catch (error) {
        console.error("Error fetching sales data:", error);
        return [];
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = "none";
    }

    function openHistoryModal() {
      renderHistoryFromGoogleSheet();
    }

    async function renderHistoryFromGoogleSheet() {
      const historyModal = document.getElementById('historyFromSheetModal');
      const historyContent = document.getElementById('historyFromSheetContent');
      const historyLoader = document.getElementById('historyLoader');

      historyModal.style.display = 'block';
      historyContent.style.display = 'none';
      historyLoader.style.display = 'flex';
      
      const salesData = await getSalesDataFromGoogleSheet("1900-01-01", "2999-12-31");
      
      historyLoader.style.display = 'none';
      historyContent.style.display = 'block';

      if (salesData.length === 0) {
          historyContent.innerHTML = '<p>ไม่พบประวัติการสั่งซื้อ</p>';
          return;
      }

      const groupedData = {};
      salesData.forEach(item => {
          const orderId = item["Order ID"];
          if (!orderId) return;

          if (!groupedData[orderId]) {
              groupedData[orderId] = {
                  orderId: orderId,
                  datetime: item["Datetime"],
                  channel: item["Channel"],
                  fee: item["Fee"],
                  finalTotal: item["Final Total"],
                  items: []
              };
          }
          
          groupedData[orderId].items.push({
              name: item["Item Name"],
              price: item["Price"],
              qty: item["Quantity"],
              subtotal: item["Total"]
          });
      });

      historyContent.innerHTML = '';
      const orderIds = Object.keys(groupedData).sort().reverse();
      orderIds.forEach(orderId => {
          const order = groupedData[orderId];
          const orderDiv = document.createElement('div');
          orderDiv.className = 'history-detail';
          orderDiv.innerHTML = `
              <h4>รายการที่: ${order.orderId || "ไม่ระบุ"}</h4>
              <p>วันที่: ${new Date(order.datetime).toLocaleString() || "ไม่ระบุ"}</p>
              <p>ช่องทาง: ${order.channel || "ไม่ระบุ"}</p>
              <div class="history-detail-items">
                  <ul>
                      ${order.items.map(item => `
                          <li>${item.name || "ไม่ระบุ"} (${item.qty} ชิ้น) - ${item.subtotal || "0"} ฿</li>
                      `).join('')}
                  </ul>
              </div>
              <p><strong>ยอดที่ได้รับ: ${order.finalTotal || "0"} ฿</strong></p>
          `;
          historyContent.appendChild(orderDiv);
      });
    }

    function openSummaryModal() {
      document.getElementById("summaryFromSheetModal").style.display = "block";
    }

    async function handleFetchAndExport() {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      if (!startDate || !endDate) {
        alert("กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด");
        return;
      }

      const summaryContent = document.getElementById("summaryFromSheetContent");
      summaryContent.innerHTML = "<p>กำลังดึงข้อมูล...</p>";

      const salesData = await getSalesDataFromGoogleSheet(startDate, endDate);
      if (salesData.length === 0) {
        summaryContent.innerHTML = "<p>ไม่พบข้อมูลในช่วงวันที่ที่เลือก</p>";
        return;
      }

      // Display summary info
      let totalSales = 0;
      let totalFee = 0;
      let totalFinal = 0;
      let totalItems = 0;

      salesData.forEach(item => {
        totalSales += parseFloat(item["Total"]);
        totalFee += parseFloat(item["Fee"]);
        totalFinal += parseFloat(item["Final Total"]);
        totalItems += parseFloat(item["Quantity"]);
      });

      const summaryHtml = `
          <h3>สรุปยอดขายระหว่างวันที่ ${startDate} ถึง ${endDate}</h3>
          <p>จำนวนรายการสินค้าทั้งหมด: ${totalItems} ชิ้น</p>
          <p>รวมยอดขายก่อนหักค่าธรรมเนียม: ${totalSales.toFixed(2)} ฿</p>
          <p>รวมค่าธรรมเนียม: ${totalFee.toFixed(2)} ฿</p>
          <p><strong>ยอดเงินที่ได้รับสุทธิ: ${totalFinal.toFixed(2)} ฿</strong></p>
          <hr/>
          <button class="btn" id="exportBtn">Export ข้อมูลเป็นไฟล์ Excel</button>
      `;
      summaryContent.innerHTML = summaryHtml;
      document.getElementById("exportBtn").onclick = () => exportToXLSX(salesData);
    }

    function exportToXLSX(data) {
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Sales Summary");
      XLSX.writeFile(wb, "Sales_Summary.xlsx");
    }

    // Event Listeners
    document.addEventListener("DOMContentLoaded", () => {
      renderProducts();
      renderChannels();
      renderCart();
      document.getElementById("fetchAndExportBtn").onclick = handleFetchAndExport;
      document.getElementById("confirmBtn").onclick = async () => {
        if (Object.keys(cart).length === 0) {
          alert("ตะกร้าว่าง โปรดเพิ่มสินค้าก่อนยืนยัน");
          return;
        }

        let subtotal = 0;
        for (const id in cart) {
          const item = cart[id];
          subtotal += item.price * item.qty;
        }

        const feeRate = channels[activeChannel] || 0;
        let fee = subtotal * feeRate;
        let finalTotal = subtotal - fee;

        const orderId =
          "INV" + new Date().toISOString().slice(0, 19).replace(/[:T]/g, "");
        const dt = new Date().toISOString();

        const orderData = {
          orderId: orderId,
          datetime: dt,
          channel: activeChannel,
          subtotal: subtotal.toFixed(2),
          fee: fee.toFixed(2),
          finalTotal: finalTotal.toFixed(2),
          items: [],
        };
        for (const id in cart) {
          const it = cart[id];
          const itemSubtotal = it.price * it.qty;
          orderData.items.push({
            name: it.name,
            price: it.price,
            qty: it.qty,
            subtotal: itemSubtotal,
          });
        }

        await saveOrderToGoogleSheet(orderData);
        cart = {};
        renderCart();
      };
    });
  </script>
</body>
</html>
